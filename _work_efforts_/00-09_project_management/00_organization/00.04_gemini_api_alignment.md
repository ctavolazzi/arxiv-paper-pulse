# Work Effort: Gemini API Documentation Alignment

## Status: In Progress
**Started:** 2025-11-01 11:42
**Last Updated:** 2025-11-01 11:42

## Objective
Review and align the arxiv-paper-pulse implementation with official Gemini API documentation patterns to ensure correct usage, optimal performance, and maintainability.

## Analysis Summary

### ✅ What's Working Correctly
1. Client initialization with API key
2. Basic content generation patterns
3. Streaming response implementation
4. System instructions in GenerateContentConfig
5. Temperature and generation parameters
6. Chat session creation with history
7. PDF file upload and processing
8. File state waiting (ACTIVE/FAILED)

### ⚠️ Issues Found

#### CRITICAL #1: Chat Method Call Syntax
**File:** `chat.py:96, 99`
**Current:**
```python
response = self.chat.send_message(message=question)
response_stream = self.chat.send_message_stream(message=question)
```
**Should be:**
```python
response = self.chat.send_message(question)
response_stream = self.chat.send_message_stream(question)
```
**Impact:** May cause errors depending on SDK version
**Priority:** HIGH

#### CRITICAL #2: Chat System Instruction Not Applied
**File:** `chat.py:32-45`
**Problem:** System instruction is defined but never passed to `chats.create()`
**Impact:** Chat sessions don't follow the intended behavior guidelines
**Priority:** HIGH

#### ISSUE #3: Missing Thinking Budget Zero Option
**File:** `core.py:656-665`, `config.py:24-26`
**Problem:** No way to disable thinking mode (budget=0) for faster/cheaper responses
**Recommendation:** Add `THINKING_BUDGET_SIMPLE = 0` config option
**Impact:** Unnecessary costs and latency for simple tasks
**Priority:** MEDIUM

#### ISSUE #4: Chat History Format
**File:** `chat.py:69-82`
**Observation:** Uses dict format instead of SDK Content objects
**Status:** May work but undocumented pattern
**Priority:** LOW (monitor for issues)

#### ISSUE #5: Schema Workaround
**File:** `core.py:671-682`
**Observation:** Manual removal of `additionalProperties` from Pydantic schema
**Status:** Workaround for SDK compatibility issue
**Priority:** LOW (revisit with SDK updates)

## Tasks

### High Priority
1. [ ] Fix chat method call syntax (remove `message=` keyword)
2. [ ] Implement chat system instruction passing
3. [ ] Test chat functionality after fixes

### Medium Priority
4. [ ] Add thinking budget zero option for simple tasks
5. [ ] Update config to include three thinking levels
6. [ ] Test performance difference with thinking=0

### Low Priority
7. [ ] Review chat history format when SDK docs clarify
8. [ ] Monitor for schema handling improvements in future SDK versions
9. [ ] Document SSE streaming layer choice

## Implementation Plan

### Phase 1: Chat Fixes (HIGH)
1. Update `chat.py` method calls to remove keyword argument
2. Research how to pass system instruction to chat (options):
   - Include in initial history message
   - Use config parameter if available
   - Pass per-message if needed
3. Test chat functionality end-to-end

### Phase 2: Thinking Budget (MEDIUM)
1. Add `THINKING_BUDGET_SIMPLE = 0` to config
2. Update `gemini_summarize()` logic to detect simple vs complex
3. Add CLI flag for manual thinking mode selection

### Phase 3: Documentation (LOW)
1. Document why dict format used for chat history
2. Document SSE streaming architecture
3. Add inline comments explaining workarounds

## Testing Checklist
- [ ] Chat sessions create successfully
- [ ] System instructions apply to chat responses
- [ ] Streaming works in chat mode
- [ ] Thinking budget=0 produces faster responses
- [ ] All existing functionality still works
- [ ] No regressions in API endpoints

## Notes
- Official docs: https://ai.google.dev/gemini-api/docs/text-generation
- SDK version in use: google-genai (check pyproject.toml)
- Chat API may have version-specific behaviors
- SSE streaming layer works but adds complexity

## Success Metrics
- ✅ All critical issues resolved
- ✅ Chat system instructions functioning
- ✅ Performance improvement with thinking=0
- ✅ No breaking changes to existing features
- ✅ Aligned with official documentation patterns

## Related Work Efforts
- [[00.01_gemini_api_integration]] - Original integration work
- [[00.02_streaming_display_fix]] - Recent streaming fixes

